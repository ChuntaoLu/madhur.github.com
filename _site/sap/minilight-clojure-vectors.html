<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Minilight in Clojure: Vectors &larr; Structure &amp; Process</title>
   <meta name="author" content="Madhur Ahuja" />

     <link rel="start" href="/" />

	
	
	
  	<link rel="alternate" type="application/atom+xml" href="atom.xml" title="RSS feed" />
	

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/files/css/screen.css" type="text/css" />

</head>
<body id="">
<div id="site">

  
<div id="header">
	<h1>
	<a href="/sap/" title="A programming blog">Structure <i>&amp;</i> Process</a>
	<span class="byline">&larr; <a href="/">Madhur Ahuja</a></span>
</h1>

</div>

<div id="page">
	
  <h1 class="emphnext">Minilight in Clojure: Vectors</h1>

<p>Now that I am happy with my Clojure <a href='/sap/setting-up-clojure.html'>set up</a>, it is time to dive in and try to implement something using it. As it happens, I recently discovered the <a href='http://www.hxa.name/minilight/'>minilight</a> project which aims to implement a &#8220;minimal global illumination renderer&#8221; in several languages including Ruby, Python, Java, Scala, and C++. I&#8217;ve dabbled with 3D graphics in the past and since there is currently no implementation<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup> in Clojure I thought porting minilight to Clojure would be a great way to start.</p>

<p>In this first part, I&#8217;ll describe how I ported the Vector3fc class from the Ruby version of minilight. I am keeping all my code for this project over at <a href='http://github.com/mreid/minilight-clojure/'>GitHub</a>. The code I&#8217;ll be talking about here is tagged &#8217;<a href='http://github.com/mreid/minilight-clojure/tree/sap-1'>sap-1</a>&#8217;.</p>

<p>I&#8217;m going to assume you have a basic familiarity with Clojure. Skimming over this overview of the <a href='http://ociweb.com/jnb/jnbMar2009.html#Syntax'>Clojure syntax</a> would be a good place to start.</p>

<h2 id='100_functions_on_one_data_structure'>100 Functions on One Data Structure</h2>

<p>Vector manipulation is central to any 3D rendering code and Minilight is no exception. In object-oriented languages like Java, Ruby, Python and C++, the general practice is to create a new class for vectors and define methods for their manipulation.</p>

<p>It is possible to do OO programming in LISP-like languages like Clojure but it is not idiomatic. As Alan Perlis put it:</p>

<blockquote>
<p>It is better to have 100 functions operate on one data structure than 10 functions on 10 data structures.</p>
</blockquote>

<p>So I&#8217;ve instead opted for defining a namespace <code>vec</code> along with a number of operations that treat lists of numbers as vectors and all live in the file <code>vec.clj</code>.</p>
<div class='highlight'><pre><span class='c1'>;; --- vec.clj ---</span>
<span class='c1'>;; A simple vector package that defines functions for working with geometrical </span>
<span class='c1'>;; vectors.</span>
<span class='p'>(</span><span class='nf'>ns</span> <span class='nv'>vec</span><span class='p'>)</span>

<span class='c1'>; Constants</span>
<span class='p'>(</span><span class='k'>def </span><span class='nv'>origin</span> <span class='p'>[</span><span class='mi'>0</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>])</span>    <span class='c1'>; Zero vector in 3D</span>
<span class='p'>(</span><span class='k'>def </span><span class='nv'>epsilon</span> <span class='mf'>0.000001</span><span class='p'>)</span>  <span class='c1'>; Tolerance for equality</span>

<span class='c1'>; Helper functions</span>
<span class='p'>(</span><span class='k'>defn </span><span class='nv'>approx0</span> 
    <span class='s'>&quot;Returns true iff the value x is within epsilon of 0&quot;</span>
    <span class='p'>[</span><span class='nv'>x</span><span class='p'>]</span> <span class='p'>(</span><span class='nb'>&lt; </span><span class='p'>(</span><span class='nf'>Math/abs</span> <span class='nv'>x</span><span class='p'>)</span> <span class='nv'>epsilon</span><span class='p'>))</span>

<span class='p'>(</span><span class='k'>defn </span><span class='nv'>clamp</span>
    <span class='s'>&quot;Constrains all elements in v to be between vmin and vmax&quot;</span>
    <span class='p'>[</span><span class='nv'>vmin</span> <span class='nv'>vmax</span> <span class='nv'>v</span><span class='p'>]</span> <span class='p'>(</span><span class='nb'>map </span><span class='p'>(</span><span class='k'>fn </span><span class='p'>[</span><span class='nv'>x</span><span class='p'>]</span> <span class='p'>(</span><span class='nb'>max </span><span class='nv'>vmin</span> <span class='p'>(</span><span class='nb'>min </span><span class='nv'>vmax</span> <span class='nv'>x</span><span class='p'>)))</span> <span class='nv'>v</span><span class='p'>))</span>

<span class='c1'>; Binary operators</span>
<span class='p'>(</span><span class='k'>defn </span><span class='nv'>dot</span> 
    <span class='s'>&quot;Returns the value of dot product of the vectors v1 and v2&quot;</span>
    <span class='p'>[</span><span class='nv'>v1</span> <span class='nv'>v2</span><span class='p'>]</span> <span class='p'>(</span><span class='nb'>reduce </span><span class='nv'>+</span> <span class='p'>(</span><span class='nb'>map </span><span class='nv'>*</span> <span class='nv'>v1</span> <span class='nv'>v2</span><span class='p'>)))</span>
    
<span class='p'>(</span><span class='k'>defn </span><span class='nv'>add</span> 
    <span class='s'>&quot;Returns a vector that is the sum of the vectors v1 and v2&quot;</span>
    <span class='p'>[</span><span class='nv'>v1</span> <span class='nv'>v2</span><span class='p'>]</span> <span class='p'>(</span><span class='nb'>map </span><span class='nv'>+</span> <span class='nv'>v1</span> <span class='nv'>v2</span><span class='p'>))</span>
    
<span class='p'>(</span><span class='k'>defn </span><span class='nv'>sub</span> 
    <span class='s'>&quot;Returns a vector that when added to v1 gives v2&quot;</span>
    <span class='p'>[</span><span class='nv'>v1</span> <span class='nv'>v2</span><span class='p'>]</span> <span class='p'>(</span><span class='nb'>map </span><span class='nv'>-</span> <span class='nv'>v1</span> <span class='nv'>v2</span><span class='p'>))</span>

<span class='p'>(</span><span class='k'>defn </span><span class='nv'>cross</span> 
    <span class='s'>&quot;Returns the cross product vector for the 3D vectors v1 and v2.&quot;</span>
    <span class='p'>[</span><span class='nv'>v1</span> <span class='nv'>v2</span><span class='p'>]</span> 
    <span class='p'>[</span> <span class='p'>(</span><span class='nb'>- </span><span class='p'>(</span><span class='nb'>* </span><span class='p'>(</span><span class='nf'>v1</span> <span class='mi'>1</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>v2</span> <span class='mi'>2</span><span class='p'>))</span> <span class='p'>(</span><span class='nb'>* </span><span class='p'>(</span><span class='nf'>v1</span> <span class='mi'>2</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>v2</span> <span class='mi'>1</span><span class='p'>)))</span>
      <span class='p'>(</span><span class='nb'>- </span><span class='p'>(</span><span class='nb'>* </span><span class='p'>(</span><span class='nf'>v1</span> <span class='mi'>2</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>v2</span> <span class='mi'>0</span><span class='p'>))</span> <span class='p'>(</span><span class='nb'>* </span><span class='p'>(</span><span class='nf'>v1</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>v2</span> <span class='mi'>2</span><span class='p'>)))</span>
      <span class='p'>(</span><span class='nb'>- </span><span class='p'>(</span><span class='nb'>* </span><span class='p'>(</span><span class='nf'>v1</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>v2</span> <span class='mi'>1</span><span class='p'>))</span> <span class='p'>(</span><span class='nb'>* </span><span class='p'>(</span><span class='nf'>v1</span> <span class='mi'>1</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>v2</span> <span class='mi'>0</span><span class='p'>)))</span> <span class='p'>])</span>

<span class='c1'>; Scalar operators</span>
<span class='p'>(</span><span class='k'>defn </span><span class='nv'>scale</span> 
    <span class='s'>&quot;Returns the vector that is m times the vector v&quot;</span>
    <span class='p'>[</span><span class='nv'>m</span> <span class='nv'>v</span><span class='p'>]</span> <span class='p'>(</span><span class='nb'>map </span><span class='o'>#</span><span class='p'>(</span><span class='nv'>*</span> <span class='nv'>m</span> <span class='nv'>%</span><span class='p'>)</span> <span class='nv'>v</span><span class='p'>))</span>

<span class='c1'>; Unary operators</span>
<span class='p'>(</span><span class='k'>defn </span><span class='nv'>norm</span> 
    <span class='s'>&quot;Returns the (Euclidean) length of the vector v&quot;</span>
    <span class='p'>[</span><span class='nv'>v</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>Math/sqrt</span> <span class='p'>(</span><span class='nf'>dot</span> <span class='nv'>v</span> <span class='nv'>v</span><span class='p'>)))</span>

<span class='p'>(</span><span class='k'>defn </span><span class='nv'>normalise</span> 
    <span class='s'>&quot;Returns a vector of unit length in the same direction as v&quot;</span>
    <span class='p'>[</span><span class='nv'>v</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>scale</span> <span class='p'>(</span><span class='nb'>/ </span><span class='mi'>1</span> <span class='p'>(</span><span class='nf'>norm</span> <span class='nv'>v</span><span class='p'>))</span> <span class='nv'>v</span><span class='p'>))</span>

<span class='c1'>; Determinants</span>
<span class='p'>(</span><span class='k'>defn </span><span class='nv'>det</span> 
    <span class='s'>&quot;Returns the determinant of vectors v1 v2 and v3, i.e. v1.(v2 x v3)&quot;</span>    
    <span class='p'>[</span><span class='nv'>v1</span> <span class='nv'>v2</span> <span class='nv'>v3</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>dot</span> <span class='nv'>v1</span> <span class='p'>(</span><span class='nf'>cross</span> <span class='nv'>v2</span> <span class='nv'>v3</span><span class='p'>)))</span>

<span class='p'>(</span><span class='k'>defn </span><span class='nv'>invdet</span>
    <span class='s'>&quot;Returns the inverse det. of v1, v2 and v3 or nil if it is too close to 0&quot;</span>
    <span class='p'>[</span><span class='nv'>v1</span> <span class='nv'>v2</span> <span class='nv'>v3</span><span class='p'>]</span>
    <span class='p'>(</span><span class='k'>let </span><span class='p'>[</span><span class='nv'>d</span> <span class='p'>(</span><span class='nf'>det</span> <span class='nv'>v1</span> <span class='nv'>v2</span> <span class='nv'>v3</span><span class='p'>)]</span>
        <span class='p'>(</span><span class='k'>if </span><span class='p'>(</span><span class='nf'>approx0</span> <span class='nv'>d</span><span class='p'>)</span>
            <span class='nv'>nil</span>
            <span class='p'>(</span><span class='nb'>/ </span><span class='mf'>1.0</span> <span class='nv'>d</span><span class='p'>))))</span>
</pre>
</div>
<p>The string that appears after a function&#8217;s name in a <code>defn</code> form documents the function. You can view this documentation for any function using the <code>doc</code> function. For example, we can see the documentation for <code>add</code> like so:</p>

<pre><code>Clojure
user=&gt; (use &#39;vec)
user=&gt; (doc add)
-------------------------
vec/add
([v1 v2])
  Returns a vector that is the sum of the vectors v1 and v2</code></pre>

<p>Here are some other observations about how I implemented these functions and some of the Clojure-related tricks I learnt along the way.</p>

<ul>
<li>
<p>Apart from the function <code>cross</code>, all of these definitions are very concise thanks to the use of the higher-order functions <code>map</code>, <code>reduce</code> and <code>every?</code> which apply functions to sequences. Writing the functions this will almost certainly be slower than dealing with arrays of floats but I can always aim to improve efficiency later and thus heed Don Knuth&#8217;s warning that &#8220;premature optimization is the root of all evil (or at least most of it) in programming.&#8221;</p>
</li>

<li>
<p>The function <code>Math/abs</code> denotes a call to the static method <code>abs()</code> in the class <code>Math</code> that comes standard with Java.</p>
</li>

<li>
<p>The form <code>#(* m %)</code> in the definition of <code>scale</code> is shorthand for <code>(fn [x] (* m x))</code>&#8212;that is, the function that multiplies its input by <code>m</code>. The shorthand is known as a <em>reader macro</em>. Clojure expands forms like these into their equivalent long version when it first encounters it.</p>
</li>

<li>
<p>The <code>let</code> form is Clojure&#8217;s way of assigning local bindings. The first vector<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup> <code>[d (det v1 v2 v3)]</code> binds <code>d</code> to the determinant of <code>v1</code>, <code>v2</code> and <code>v3</code>. In general, a <code>let</code> can take many pairs of symbol/value bindings like so: <code>let [a 1 b 2 c3] (...)</code>. The form after the binding is evaluated in the context of the bindings.</p>
</li>
</ul>

<h2 id='testing_testing'>Testing, testing</h2>

<p>Writing tests for your code is almost always a good idea, especially if most of the code being tested does some kind of number-crunching. Since I plan to rewrite and optimise my vector functions later it is <em>definitely</em> a good idea.</p>

<p>Clojure comes with some built-in support for testing via its <a href='http://clojure.org/special_forms'>special form</a> <code>:test</code> which allows tests to sit right next to the code, much like documentation. However, I prefer separating tests into their own files so I&#8217;ve been using <a href='http://stuartsierra.com/'>Stuart Sierra</a>&#8217;s test-is library that comes with the <a href='http://code.google.com/p/clojure-contrib/'>clojure-contrib</a> package. It is a basic unit testing library that allows me to write simple tests for the above vector methods.</p>

<p>Here is a small suite of tests for the vector functions. These appear in the file <code>test/vec.clj</code> which means the appropriate namespace is <code>test.vec</code>. Note the <code>:use</code> form after the definition which imports all the functions in <code>vec</code> and the <code>test-is</code> library.</p>
<div class='highlight'><pre><span class='c1'>;; --- test/vec.clj ---</span>
<span class='c1'>;; Tests for vec.clj using the test-is library.</span>
<span class='p'>(</span><span class='nf'>ns</span> <span class='nv'>test</span><span class='o'>.</span><span class='nv'>vec</span>
    <span class='p'>(</span><span class='nf'>:use</span> <span class='nv'>vec</span> <span class='nv'>clojure</span><span class='o'>.</span><span class='nv'>contrib</span><span class='o'>.</span><span class='nv'>test-is</span><span class='p'>))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-approx0</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nf'>approx0</span> <span class='mf'>-0.000000001</span><span class='p'>))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>not </span><span class='p'>(</span><span class='nf'>approx0</span> <span class='mf'>0.001</span><span class='p'>))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-clamp</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>1</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span>       <span class='p'>(</span><span class='nf'>clamp</span> <span class='mi'>0</span> <span class='mi'>1</span> <span class='p'>[</span><span class='mi'>2</span> <span class='mi'>-1</span> <span class='mi'>-1</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mf'>0.5</span> <span class='mf'>0.5</span> <span class='mf'>0.5</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>clamp</span> <span class='mi'>0</span> <span class='mi'>1</span> <span class='p'>[</span><span class='mf'>0.5</span> <span class='mf'>0.5</span> <span class='mf'>0.5</span><span class='p'>]))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-dot</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='mi'>0</span> <span class='p'>(</span><span class='nf'>dot</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>1</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>-1</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='mi'>2</span> <span class='p'>(</span><span class='nf'>dot</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>3</span> <span class='mi'>-2</span> <span class='mi'>1</span><span class='p'>]))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-add</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>]</span>  <span class='p'>(</span><span class='nf'>add</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>]</span> <span class='nv'>origin</span><span class='p'>)))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>-2</span> <span class='mi'>3</span> <span class='mi'>4</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>add</span> <span class='nv'>origin</span> <span class='p'>[</span><span class='mi'>-2</span> <span class='mi'>3</span> <span class='mi'>4</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span>  <span class='p'>(</span><span class='nf'>add</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>-1</span> <span class='mi'>2</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>0</span> <span class='mi'>3</span> <span class='mi'>1</span><span class='p'>]))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-sub</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span>  <span class='p'>(</span><span class='nf'>sub</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='nv'>origin</span><span class='p'>)))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>0</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span>  <span class='p'>(</span><span class='nf'>sub</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>-2</span> <span class='mi'>0</span> <span class='mi'>2</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>sub</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>3</span> <span class='mi'>2</span> <span class='mi'>1</span><span class='p'>]))))</span>
    
<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-scale</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>0</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span>    <span class='p'>(</span><span class='nf'>scale</span> <span class='mi'>0</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>-1</span> <span class='mi'>-2</span> <span class='mi'>-3</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>scale</span> <span class='mi'>-1</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>2</span> <span class='mi'>4</span> <span class='mi'>6</span><span class='p'>]</span>    <span class='p'>(</span><span class='nf'>scale</span> <span class='mi'>2</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-cross</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>-3</span> <span class='mi'>6</span> <span class='mi'>-3</span><span class='p'>]</span> <span class='p'>(</span><span class='nf'>cross</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>4</span> <span class='mi'>5</span> <span class='mi'>6</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>0</span> <span class='mi'>0</span> <span class='mi'>1</span><span class='p'>]</span>   <span class='p'>(</span><span class='nf'>cross</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>0</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[</span><span class='mi'>0</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span>   <span class='p'>(</span><span class='nf'>cross</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-norm</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='mi'>0</span> <span class='p'>(</span><span class='nf'>norm</span> <span class='nv'>origin</span> <span class='p'>)))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>(</span><span class='nf'>Math/sqrt</span> <span class='mi'>3</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>norm</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>1</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>(</span><span class='nf'>Math/sqrt</span> <span class='mi'>2</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>norm</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>0</span> <span class='mi'>-1</span><span class='p'>]))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-normalise</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>[(</span><span class='nb'>/ </span><span class='mf'>2.0</span> <span class='mf'>7.0</span><span class='p'>)</span> <span class='p'>(</span><span class='nb'>/ </span><span class='mf'>3.0</span> <span class='mf'>7.0</span><span class='p'>)</span> <span class='p'>(</span><span class='nb'>/ </span><span class='mf'>6.0</span> <span class='mf'>7.0</span><span class='p'>)]</span> <span class='p'>(</span><span class='nf'>normalise</span> <span class='p'>[</span><span class='mi'>2</span> <span class='mi'>3</span> <span class='mi'>6</span><span class='p'>]))))</span>

<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-det</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='mi'>1</span> <span class='p'>(</span><span class='nf'>det</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>0</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>0</span> <span class='mi'>0</span> <span class='mi'>1</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='mi'>3</span> <span class='p'>(</span><span class='nf'>det</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>4</span> <span class='mi'>5</span> <span class='mi'>6</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='mi'>0</span> <span class='p'>(</span><span class='nf'>det</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>1</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>4</span> <span class='mi'>5</span> <span class='mi'>6</span><span class='p'>]))))</span>
    
<span class='p'>(</span><span class='nf'>deftest</span> <span class='nv'>test-invdet</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='mi'>1</span> <span class='p'>(</span><span class='nf'>invdet</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>0</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>0</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>0</span> <span class='mi'>0</span> <span class='mi'>1</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>= </span><span class='p'>(</span><span class='nb'>/ </span><span class='mi'>1</span> <span class='mi'>3</span><span class='p'>)</span> <span class='p'>(</span><span class='nf'>invdet</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>0</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>4</span> <span class='mi'>5</span> <span class='mi'>6</span><span class='p'>])))</span>
    <span class='p'>(</span><span class='nf'>is</span> <span class='p'>(</span><span class='nb'>nil? </span><span class='p'>(</span><span class='nf'>invdet</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>1</span> <span class='mi'>1</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>1</span> <span class='mi'>2</span> <span class='mi'>3</span><span class='p'>]</span> <span class='p'>[</span><span class='mi'>4</span> <span class='mi'>5</span> <span class='mi'>6</span><span class='p'>]))))</span>
</pre>
</div>
<p>As you can see, these are fairly basic tests but they do exercise all of the important functions in <code>vec.clj</code>.</p>

<p>The tests can be run from the interactive session of Clojure like so:</p>

<pre><code>Clojure
user=&gt; (use &#39;test.vec &#39;clojure.contrib.test-is)
user=&gt; (run-tests &#39;test.vec)                   

Testing test.vec

Ran 11 tests containing 28 assertions.
0 failures, 0 errors.</code></pre>

<p>No failures. Excellent!</p>

<p>To avoid having to run these tests manually, I&#8217;ve set up a master test file in <code>test/test.clj</code> that looks like this:</p>
<div class='highlight'><pre><span class='p'>(</span><span class='nf'>ns</span> <span class='nv'>test</span> 
	<span class='p'>(</span><span class='nf'>:use</span> <span class='nv'>test</span><span class='o'>.</span><span class='nv'>vec</span><span class='p'>)</span>
	<span class='p'>(</span><span class='nf'>:use</span> <span class='nv'>clojure</span><span class='o'>.</span><span class='nv'>contrib</span><span class='o'>.</span><span class='nv'>test-is</span><span class='p'>))</span>

<span class='p'>(</span><span class='nf'>run-tests</span> <span class='ss'>&#39;test</span><span class='o'>.</span><span class='nv'>vec</span><span class='p'>)</span>
</pre>
</div>
<p>This will be make it easier to add new test suites as I write port more of Minilight and can be run as a script from the Terminal like so:</p>

<pre><code>$ clj test/test.clj 

Testing test.vec

Ran 11 tests containing 28 assertions.
0 failures, 0 errors.</code></pre>

<h2 id='in_closing'>In Closing</h2>

<p>Well, that&#8217;s covered the vector functions and their tests. In the next part I&#8217;ll port the Triangle class which defines the geometry and properties of a triangle.</p>

<p>I&#8217;d like to emphasise that I&#8217;m very new to Clojure so if you see that I&#8217;m doing something unidiomatic or just plain stupid in the above please let me know in the comments.</p>
<div class='footnotes'><hr /><ol><li id='fn:1'>
<p>Shortly after starting my port of minilight I discovered that <a href='http://www.fatvat.co.uk/2009/04/implementing-minilight-in-clojure-2.html'>someone else</a> had the same idea and is at about the same stage. It will be interesting to compare our respective approaches as time goes on, and I cannot promise that I won&#8217;t borrow an idea or two.</p>
<a href='#fnref:1' rev='footnote'>&#8617;</a></li><li id='fn:2'>
<p>This is slightly confusing since Clojure sequences defined using square brackets (e.g., <code>[1 2 3]</code>) are called &#8220;vectors&#8221; after the Java class of the same name.</p>
<a href='#fnref:2' rev='footnote'>&#8617;</a></li></ol></div>

  <address class="signature">
    <a class="author" href="http://mark.reid.name">Mark Reid</a> 
    <span class="date">05 April 2009</span>
    <span class="location">Canberra, Australia</span>
  </address>
</div><!-- End Page -->

<!-- Delicious hits
<script type="text/javascript">
    if (typeof window.Delicious == "undefined") window.Delicious = {};
    Delicious.BLOGBADGE_DEFAULT_CLASS = 'delicious-blogbadge-line';
</script>
<script src="http://static.delicious.com/js/blogbadge.js"></script>
-->


<!-- Discus Comments -->
<div id="disqus_thread"></div>

<!-- Enable Disqus comments -->
<script type="text/javascript">
	var disqus_iframe_css = "http://mark.reid.name/css/screen.css";
	var disqus_title = "Minilight in Clojure: Vectors";
	var disqus_message = "In an attempt to learn Clojure I am translating the minilight ray-tracer. In this first part I build and test a simple 3D vector package.";
</script>
<script type="text/javascript" src="http://disqus.com/forums/structure-and-process/embed.js"></script>

<noscript>
	<a href="http://structure-and-process.disqus.com/?url=ref">View the discussion thread.</a>
</noscript>
  
  <div id="footer">
	<address>
		<span class="copyright">
			Content &amp; Design by 
			<a href="/info/site.html">Madhur Ahuja</a>
			<br/>
			(Some rights reserved)			
		</span>
		<span class="engine">
			Powered by 
			<a href="http://github.com/mreid/jekyll/" title="A static, minimalist CMS">Jekyll</a>
		</span>
	</address>
  </div>
</div>
<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->
</body>
</html>
